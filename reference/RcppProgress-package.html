<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This package allows to display a progress bar in the R
    console for long running computations taking place in c++ code,
    and provides support for interrupting those computations even in a multithreaded code."><title>An interruptible progress bar with OpenMP support for c++ in R packages — RcppProgress-package • RcppProgress</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An interruptible progress bar with OpenMP support for c++ in R packages — RcppProgress-package"><meta property="og:description" content="This package allows to display a progress bar in the R
    console for long running computations taking place in c++ code,
    and provides support for interrupting those computations even in a multithreaded code."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">RcppProgress</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/kforner/rcpp_progress/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An interruptible progress bar with OpenMP support for c++ in R packages</h1>
      
      <div class="d-none name"><code>RcppProgress-package.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This package allows to display a progress bar in the R
    console for long running computations taking place in c++ code,
    and provides support for interrupting those computations even in a multithreaded code.</p>
    </div>


    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    

<p>When implementing CPU intensive computations in C++ in R packages, it is natural to want to monitor
the progress of those computations, and to be able to interrupt them, even when using
multithreading for example with OpenMP.
Another feature is that it can be done so that the code will still work even without OpenMP support.
This package offers some facilities to help implementing those features.
It it biased towards the use of OpenMP, but it should be compatible when using
multithreading in other ways.</p>
<div class="section">
<h3 id="quick-try">quick try<a class="anchor" aria-label="anchor" href="#quick-try"></a></h3>
<p>There are two tests functions provided by the package to get a quick overview
  of what can be done.</p>
<p>These tests are:</p>
<dl><dt> test_sequential(max, nb, display_progress) </dt>
<dd><p>- a sequential code, i.e. single threaded</p></dd>

<dt> test_multithreaded(max, nb, threads, display_progress) </dt>
<dd><p>- a multithreaded code using OpenMP</p></dd>


</dl><p>They both are wrappers for examples implemented in the RcppProgressExample package
located in the <code>examples</code> directory of the RcppProgress installed package.</p>

<p>Both tests call the very same function that implements a long computation.
The <b>max</b> parameter controls the number of computations, and <b>nb</b> controls the duration of a single computation,
that is quadratic in <b>nb</b>.
The <b>threads</b> is as expected the number of threads to use for the computation.
The <b>progress</b> parameter toggles the display of the progress bar.</p>
<p>On my platform,</p><div class="sourceCode"><pre><code><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span> <span class="fu"><a href="../reference/test_multithreaded.html">test_multithreaded</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">3000</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div><p>is a good start.</p>
</div>

<div class="section">
<h3 id="c-usage">c++ usage<a class="anchor" aria-label="anchor" href="#c-usage"></a></h3>


<p>There are usually two locations in the c++ code that needs to be modified.
The first one is the main loop, typically on the number of jobs or tasks. This loop is a good candidate to
be parallelized using OpenMP.
I will comment the code corresponding to the tests included with the package.</p>

<div class="sourceCode"><pre><code>
void test_multithreaded_omp(int max, int nb, int threads
                              , bool display\_progress) {

\#ifdef _OPENMP
    if ( threads &gt; 0 )
        omp_set_num_threads( threads );
    REprintf(\"Number of threads=%i\n\", omp_get_max_threads());
\#endif

    Progress p(max, display_progress); // create the progress monitor
#pragma omp parallel for schedule(dynamic)
    for (int i = 0; i &lt; max; ++i) {
        if ( ! p.is_aborted() ) { // the only way to exit an OpenMP loop
            long_computation(nb);
            p.increment(); // update the progress
        }
    }
}
</code></pre></div>

<p>Here we create a Progress object with the number of tasks to perform, then
before performing a task we test for abortion (<code>p.is_aborted()</code>), because we can not exit an
OpenMP loop the usual way, suing a break for example, then
when after the computation, we increment the progress monitor.</p>
<p>Then let us look at the computation function (that is completely useless) :</p>
<div class="sourceCode"><pre><code>
double long_computation(int nb) {
    double sum = 0;
    for (int i = 0; i &lt; nb; ++i) {
      if ( Progress::check_abort() ) // check for user abort
        return -1;
      for (int j = 0; j &lt; nb; ++j) {
        sum += Rf_dlnorm(i+j, 0.0, 1.0, 0);
      }
    }
  }
  return sum;
}
</code></pre></div>

<p>Here the only interesting line is the  <code>Progress::check_abort()</code> call.
If called from the master thread, it will check for user interruption, and if needed
set the abort status code.
When called from another thread it will just check the status.
So all the art is to decide where to put his call: it should not be called not too often
or not frequently enough.
As a rule of thumb it should be called roughly evevry second.</p>
</div>

<div class="section">
<h3 id="using-rcppprogress-in-your-package">Using RcppProgress in your package<a class="anchor" aria-label="anchor" href="#using-rcppprogress-in-your-package"></a></h3>


<p>Please note that we provide the <b>RcppProgressExample</b> example package along with this package,
	located in the <code>examples</code> directory of the installed package.</p>
<p>Here are the steps to use RcppProgress in a new package:</p>
<dl><dt> skeleton </dt>
<dd><p>create a package skeleton using Rcpp</p><div class="sourceCode"><pre><code><span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org" class="external-link">Rcpp</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/Rcpp.package.skeleton.html" class="external-link">Rcpp.package.skeleton</a></span><span class="op">(</span><span class="st">"RcppProgressExample"</span><span class="op">)</span></span></code></pre></div>
</dd>


<dt> DESCRIPTION </dt>
<dd><p>edit the <b>DESCRIPTION</b> file  and add RcppProgress to
the <strong>Depends:</strong> and <strong>LinkingTo:</strong> lines. e.g.</p><div class="sourceCode"><pre><code>
Depends: Rcpp (&gt;= 0.9.4), RcppProgress (&gt;= 0.1)
LinkingTo: Rcpp, RcppProgress
</code></pre></div><p></p></dd>


<dt> MakeVars </dt>
<dd><p>edit <b>src/MakeVars</b> and replace its content by</p>
<p>PKG_LIBS = `$(R_HOME)/bin/Rscript -e "Rcpp:::LdFlags()"` $(SHLIB_OPENMP_CXXFLAGS)
and</p>
<p>PKG_CXXFLAGS +=-Ilibsrc $(SHLIB_OPENMP_CXXFLAGS)</p></dd>


<dt> c++ code </dt>
<dd><p>Put your code in <b>src</b>.
You may for instance copy the RcppProgressExample/src/tests.cpp file in <b>src</b>, and  RcppProgressExample/R/tests.R in
<b>R</b>, and try to
compile the package (<code>R CMD INSTALL -l test .</code>) and execute the tests:</p>
<div class="sourceCode"><pre><code>
<!-- %R -->
&gt;library(RcppProgressExample, lib.loc="test")
&gt;RcppProgressExample::test_multithreaded(100, 600, 4)
</code></pre></div>
</dd>



</dl></div><p><!-- % subsection --></p>

<div class="section">
<h3 id="using-rcppprogress-with-rcpparmadillo">Using RcppProgress with RcppArmadillo<a class="anchor" aria-label="anchor" href="#using-rcppprogress-with-rcpparmadillo"></a></h3>
<p>We also provide the <b>RcppProgressArmadillo</b> example package along with this package,
located in the <code>examples</code> directory of the installed package.</p>
<p>The peculiarity is that you have to include the RcppArmadillo.h header before the
progress.hpp RcppProgress header, and add the RcppArmadillo in the LinkingTo:
field of the package DESCRIPTION file.</p>


</div><p><!-- % subsection --></p>


    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<dl><dt> OpenMP </dt>
<dd><p>API specification for parallel programming: <a href="http://openmp.org" class="external-link">http://openmp.org</a></p></dd>


<dt> Rcpp </dt>
<dd><p><a href="http://r-forge.r-project.org/projects/rcpp" class="external-link">http://r-forge.r-project.org/projects/rcpp</a></p></dd>


</dl></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Karl Forner</p>
<p>Maintainer: Karl Forner &lt;karl.forner@quartzbio.com&gt;</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span>  <span class="co"># these are implemented as examples inside RcppProgress provided</span></span></span>
<span class="r-in"><span>  <span class="co"># example package: examples/RcppProgressExample</span></span></span>
<span class="r-in"><span>  <span class="co"># check the source code</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># the underlying test_test_multithreaded c++ function is multithreaded</span></span></span>
<span class="r-in"><span>  <span class="co"># , has a progress bar and is still interruptible</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="test_multithreaded.html">test_multithreaded</a></span><span class="op">(</span>nb <span class="op">=</span> <span class="fl">300</span>, threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Karl Forner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

